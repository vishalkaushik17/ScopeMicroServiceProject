let jsTokenObject={schoolName:"",token:"",id:""},cacheKey="",useCache=!0,keyPressStatus="",backroundCache=!0,jsFormObject={},cacheKeyLibrary="",cacheKeyRoom="",cacheKeySection="",sessionId="",apiModuleLibrary="",apiModuleRoom="",apiModuleSection="",libId="",roomId="",sectionId="",apiUrlToGetAllLibrary="",apiUrlToGetAllRoom="",apiUrlToGetAllSection="",apiUrlToSectionGetById="";$("#modal-default").on("keydown",n=>{n.key==="Escape"&&($("#modal-default").modal("toggle"),resetButtonState())});$(window).keydown(function(n){keyPressStatus!=="N"&&n.ctrlKey&&(n.which===105||n.which===73)&&($("#newRecord").trigger("click"),keyPressStatus===""&&(keyPressStatus="N"),changeButtonCRUDState(),n.preventDefault())});$(window).keydown(function(n){let t=115,i=83;n.ctrlKey&&(n.which===t||n.which===i)&&($("#submit-btn").trigger("click"),n.preventDefault());n.ctrlKey&&n.altKey&&(n.which===t||n.which===i)&&($("#submit-btn").trigger("click"),n.preventDefault())});$("#modal-default").on("shown.bs.modal",function(){$(".first").focus()});let resetButtonState=function(){$("#newRecordLi").css("display","block");$("#saveLi").css("display","none");$("#cancelLi").css("display","none");keyPressStatus="";$("#modelForm").each(function(){this.reset()});$("#Id").val("")};$(document).ready(async function(){$("#model-close-x").click(function(){resetButtonState()});$("#newRecord").click(function(){changeButtonCRUDState()});$("#cancelRecord").click(function(){resetButtonState()})});let getFormElementsData=function(n){let i=n.serializeArray(),t={};return $.map(i,function(n){t[n.name]=n.value}),t},displayAlert=async function(n,t){if(toastr.options={closeButton:!0,newestOnTop:!1,progressBar:!0,preventDuplicates:!0,onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},t==="Index")return toastr.success("Record populated : "+n.recordCount,n.status),null;if((n.messageType=="Information"||n.messageType=="Message")&&toastr.success(n.message,n.status),(n.messageType=="Error"||n.messageType=="Exception")&&toastr.error(n.message,n.status),n.messageType=="Warning"||n.messageType=="ModelState"||n.messageType=="DefaultRecordWarning"){if(n.messageType=="ModelState"){let t="";return n.modelStateErrors.forEach(function(n){t+=n+"<br>"}),toastr.warning(t,n.status),null}toastr.error(n.message,n.status)}},bindDataTable=async function(n){return myTable=n.DataTable({deferRender:!0,paging:!0,lengthChange:!1,searching:!0,ordering:!0,info:!0,autoWidth:!1,sDom:"lfrtip"}),await myTable},showLoader=function(){$("#loading").show()},hideLoader=function(){$("#loading").hide()},printLog=function(n,t){console.log(`===========${t}=============`);console.log(n);console.log("===========<End>=============")},PopulateItemsTable=async function(){jsFormObject.useCache=!0;PopulateItemsOnIndex(jsFormObject)},RefreshIndexWithoutCache=async function(){await clearCache();jsFormObject.useCache=!1;window.$("#indexDataTable").DataTable().destroy();window.$("#indexDataTable tbody").empty();PopulateItemsOnIndex(jsFormObject)},PopulateItemsOnIndex=async function(n){let t=await GetDataFromLocalStorage(n.cacheKey,n.sessionId,n.useCache);if(t!=null){await n.fnTableFill(t);window.$(".searchLabel").focus();return}window.$.ajax({url:`https://localhost/ApiGateway/${jsFormObject.apiModule}/getall?useCache=${backroundCache}`,type:"GET",datatype:"json",headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token},beforeSend:function(){showLoader()},success:function(t){SetDataToLocalStorage(n.cacheKey,n.sessionId,t,20);n.FillIndex(t);window.$(".searchLabel").focus()},error(n){console.log(n);toastr.error("Oops! something went wrong!","Error!");hideLoader()},complete:function(){hideLoader()}})};$("#modelForm").submit(async function(n){showLoader();n.preventDefault();let i=getFormElementsData($(this)).Id,u=JSON.stringify(getFormElementsData($(this))),r=`https://localhost/ApiGateway/${jsFormObject.apiModule}/save?useCache=${backroundCache}`;i!=""&&(r=`https://localhost/ApiGateway/${jsFormObject.apiModule}/update?id=${i}&useCache=${backroundCache}`);let t={};t.urlPathToSave=r;t.formData=u;t.cacheKey=cacheKey;t.id=sessionId;t.apiUrlToGetAll=`https://localhost/ApiGateway/${jsFormObject.apiModule}/getall?useCache=${backroundCache}`;t.fnTableFill=FillIndex;await submitForm(t)});let submitForm=async function(n){$.ajax({type:"POST",url:n.urlPathToSave,data:n.formData,headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token,"Content-Type":"application/json; charset=utf-8"},beforeSend:function(){showLoader()},success:function(t){if(displayAlert(t),t.status==="Success"){let i=t.Result;$("#modal-default").modal("toggle");$("#indexDataTable").DataTable().destroy();$("#indexDataTable tbody").empty();GetDataFromLocalStorage(n.cacheKey,n.id).then(function(r){r?(addRowToIndex(r,i,t.Result.id),n.fnTableFill(r)):printLog("No cache data","local cache")}).catch(n=>{console.log(n.message)});$("#modelForm").each(function(){this.reset()});$("#Id").val("");resetButtonState()}hideLoader()},error:function(n,t,i){console.log(n);console.log(t);console.log(i);toastr.warning("Opps! Something went wrong!","Error")},complete:function(){hideLoader()}})},loadData=async function(n){$.ajax({type:"GET",datatype:"json",url:`${n.apiUrlToGetById}${n.id}`,headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token,"Content-Type":"application/json; charset=utf-8"},success:function(n){n.status==="Success"&&(hideLoader(),$("#modal-default").modal("show"),FillModelFormForEditingRecord(n.Result));n.Result.isEditable===!1&&($("#saveLi").css("display","none"),$("#cancelLi").css("display","block"))},error:function(n,t,i){console.log(n);console.log(t);console.log(i);toastr.warning("Opps! something went wrong!","Error")},complete:function(){hideLoader()}})};$(document).on("click",".open-Model",async function(){let t=$(this).data("id");showLoader();changeButtonCRUDState();let n={};n.apiUrlToGetById=apiUrlToGetById;n.FillModelFormForEditingRecord;n.id=t;loadData(n)});let changeButtonCRUDState=async function(n){$("#newRecordLi").css("display","none");$("#cancelLi").css("display","block");$("#saveLi").css("display","block");n===undefined&&$("#modelForm").each(function(){this.reset()})};$(document).on("click",".delete-Record",async function(){let n=$(this).data("id"),t=$(this);swal({title:"Are you sure?",text:"Once deleted, you will not be able to recover this record!",icon:"warning",buttons:!0,dangerMode:!0}).then(i=>{i&&(showLoader(),deleteData(t,`https://localhost/ApiGateway/${jsFormObject.apiModule}/delete?id=${n}&useCache=${backroundCache}`))})});let deleteData=async function(n,t){$.ajax({type:"GET",datatype:"json",url:t,headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token,"Content-Type":"application/json; charset=utf-8"},success:function(t){if(hideLoader(),t.status==="Success"){GetDataFromLocalStorage(`${cacheKey}`,sessionId,jsFormObject.useCache).then(function(n){if(n&&(n.Result=n.Result.filter(n=>n.id!==t.Result.id),SetDataToLocalStorage(`${cacheKey}`,sessionId,n,20),n.Result.length>0)){FillIndex(n);$(".searchLabel").focus();return}});swal("Ohh! Your record has been deleted!",{icon:"success",timer:3e3});let i=$("#indexDataTable").DataTable();i.row(n.parents("tr")).remove().draw()}else swal("Ohh! "+t.message,{icon:"error"})},error:function(n,t,i){console.log(n);console.log(t);console.log(i);toastr.warning(i,"Error!");hideLoader()},complete:function(){hideLoader()}})};