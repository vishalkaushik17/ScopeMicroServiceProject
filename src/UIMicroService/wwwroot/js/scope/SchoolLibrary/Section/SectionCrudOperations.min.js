var cacheKeyLibrary="LibraryModule",cacheKeyRoom="RoomModule",cacheKeySection="SectionModule",sessionId=`Sections_${scopeTokenData.id}`,apiModuleLibrary="Library",apiModuleRoom="Room",apiModuleSection="Section",libId="",roomId="",sectionId="",apiUrlToGetAllLibrary=`https://localhost/ApiGateway/${apiModuleLibrary}/getall`,apiUrlToGetAllRoom=`https://localhost/ApiGateway/${apiModuleRoom}/getall?libraryId=${libId}`,apiUrlToGetAllSection=`https://localhost/ApiGateway/${apiModuleSection}/getall?roomid=${roomId}`,apiUrlToSectionGetById=`https://localhost/ApiGateway/${apiModuleRoom}/get?roomId=${roomId}&sectionid=${sectionId}`,clearCache=async function(){await AdminLayout.clear().then(function(){SetDataToLocalStorage("Config","Application Configuration",defaultValue)}).catch(function(n){console.log(n)})},FetchSectionRecords,submitForm,loadSectionRecordForEdit,deleteSectionData;$(document).ready(async function(){$("#LayoutUl li").removeClass("active");$("#LibraryLI").addClass("active treeview");$("#Section-LibraryModule a").css({color:"darkblue","font-weight":"bold"});jsFormObject.apiUrlToGetAllLibrary=apiUrlToGetAllLibrary;jsFormObject.cacheKeyLibrary=cacheKeyLibrary;jsFormObject.cacheKeyRoom=cacheKeyRoom;jsFormObject.sessionId=sessionId;jsFormObject.FillSectionTable=fillSectionTable;jsFormObject.useCache=!0;jsFormObject.fillLibrarySelectList=fillDataInLibrarySelectList;var n=await GetConfigData("Config");backroundCache=n.UseRedisCache;$("#SelectedRoomsOnIndex").prop("disabled",!0);await FetchLibraryRecords(jsFormObject,$("#SelectedLibrariesOnIndex"))});let RefreshSectionIndexWithoutCache=async function(){$("#indexDataTable").DataTable().destroy();$("#indexDataTable tbody").empty();$("#SelectedLibrariesOnIndex").empty();$("#SelectedRoomsOnIndex").prop("disabled",!0);$("#SelectedRoomsOnIndex").empty();$("#SelectedRoomsOnIndex").append($("<option><\/option>").attr("value",-1).text("Select Room"));await FetchLibraryRecords(jsFormObject,$("#SelectedLibrariesOnIndex"))};$("#SelectedLibrariesOnIndex").on("change",async function(){if(jsFormObject.libId===""||jsFormObject.libId==="-1"){$("#SelectedRoomsOnIndex").prop("disabled",!0);return}jsFormObject.libId=$("#SelectedLibrariesOnIndex").val();$("#SelectedRoomsOnIndex").empty();$("#SelectedRoomsOnIndex").append($("<option><\/option>").attr("value",-1).text("Select Room"));FetchRoomRecords(jsFormObject,$("#SelectedRoomsOnIndex"))});$("#Libraries").on("change",async function(){if($("#Rooms").empty(),$("#Rooms").append($("<option><\/option>").attr("value",-1).text("Select Room")),$("#Name").prop("disabled",!0),this.value===""||this.value==="-1"){$("#Rooms").prop("disabled",!0);return}jsFormObject.libId=$("#Libraries").val();$("#LibraryId").val(this.value);FetchRoomRecords(jsFormObject,$("#Rooms"))});$("#Rooms").on("change",async function(){if(this.value==="-1"){$("#Name").prop("disabled",!0);return}$("#Name").prop("disabled",!1);$("#RoomsId").val(this.value)});$("#SelectedRoomsOnIndex").on("change",async function(){$("#indexDataTable").DataTable().destroy();$("#indexDataTable tbody").empty();jsFormObject.apiUrlToGetAllLibrary=apiUrlToGetAllLibrary;jsFormObject.cacheKeyLibrary=cacheKeyLibrary;jsFormObject.cacheKeyRoom=cacheKeyRoom;jsFormObject.sessionId=sessionId;jsFormObject.FillSectionTable=fillSectionTable;jsFormObject.useCache=!0;jsFormObject.fillLibrarySelectList=fillDataInLibrarySelectList;var n=await GetConfigData("Config");backroundCache=n.UseRedisCache;jsFormObject.libId=$("#SelectedLibrariesOnIndex").val();jsFormObject.roomId=$("#SelectedRoomsOnIndex").val();FetchSectionRecords(this.value,jsFormObject.libId,jsFormObject)});let FetchLibraryRecords=async function(n,t){var i=await GetDataFromLocalStorage(n.cacheKeyLibrary,n.sessionId,n.useCache);if(i!==null){if(i.recordCount===0){toastr.warning(data.message,"Warning");$("#SelectedLibrariesOnIndex").prop("disabled",!0);return}n.fillLibrarySelectList(i,t,"Select Library");t.focus();return}window.$.ajax({url:`https://localhost/ApiGateway/${apiModuleLibrary}/getall?useCache=${backroundCache}`,type:"GET",datatype:"json",headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token},beforeSend:function(){showLoader()},success:function(i){if(i.status==="Success"){if(i.recordCount===0){toastr.warning(i.message,"Warning");$("#SelectedLibrariesOnIndex").prop("disabled",!0);return}SetDataToLocalStorage(n.cacheKeyLibrary,n.sessionId,i,20);n.fillLibrarySelectList(i,t,"Select Library");t.focus()}},error(n){console.log(n);toastr.error("Oops! something went wrong!","Error!");hideLoader()},complete:function(){hideLoader()}})},FetchRoomRecords=async function(n,t){var i=await GetDataFromLocalStorage(`${n.cacheKeyRoom}_${n.libId}`,n.sessionId,n.useCache);if(i!==null){if(i.recordCount===0){toastr.warning(data.message,"Warning");t.prop("disabled",!0);return}n.fillLibrarySelectList(i,t,"Select Room");t.prop("disabled",!1);t.focus();return}window.$.ajax({url:`https://localhost/ApiGateway/${apiModuleRoom}/getall?useCache=${backroundCache}&libraryId=${n.libId}`,type:"GET",datatype:"json",headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token},beforeSend:function(){showLoader()},success:function(i){if(i.status==="Success"){if(i.recordCount===0){toastr.warning(i.message,"Warning");t.prop("disabled",!0);return}SetDataToLocalStorage(`${n.cacheKeyRoom}_${n.libId}`,n.sessionId,i,20);t.prop("disabled",!1);n.fillLibrarySelectList(i,t,"Select Room");t.focus()}},error(n){console.log(n);toastr.error("Oops! something went wrong!","Error!");hideLoader()},complete:function(){hideLoader()}})};FetchSectionRecords=async function(n,t){if(t!=="-1"&&n!=="-1"){var i=await GetDataFromLocalStorage(`${cacheKeySection}_${n}`,sessionId,useCache);if(i!=null){i.recordCount>0&&fillSectionTable(i);return}$.ajax({url:`https://localhost/ApiGateway/section/getAll?useCache=${backroundCache}&roomId=${n}`,type:"GET",datatype:"application/json",headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token,"Content-Type":"application/json; charset=utf-8"},beforeSend:function(){showLoader()},success:function(t){t.status==="Success"&&t.recordCount>0&&(SetDataToLocalStorage(`${cacheKeySection}_${n}`,sessionId,t,20),fillSectionTable(t),window.$("#SelectedLibraries").focus())},error(n){console.log(n);$(window).ready(hideLoader);toastr.error("Oops! something went wrong!","Error!");setTimeout(hideLoader,2e4)},complete:function(){$(window).ready(hideLoader);setTimeout(hideLoader,2e4)}})}};let fillDataInLibrarySelectList=async function(n,t,i){t.empty();t.append($("<option><\/option>").attr("value",-1).text(i));$.each(n.Result,function(n,i){t.append($("<option><\/option>").attr("value",i.id).text(i.name))})},fillSectionTable=async function(n){$.each(n.Result,function(n,t){var i="<tr>";hrefid="#modal-default";hrefdel="class='delete-SectionRecord'";hrefEdit="class='edit-RecordSection'";editIcon="<i class='ion ion-edit btn btn-info' style='font-size:20px;'><\/i>";delIcon="<i class='ion ion-trash-b btn btn-warning' style='font-size:20px;'><\/i>";i+=`<td> <a href= '${hrefid}' class='open-ModelSection' data-Id='${t.id}' data-libraryId='${t.libraryId}' data-roomId='${t.roomId}'> ${t.name}</a></td>`;i+=t.isEditable===!0?`<td> <a href='#' ${hrefEdit} data-Id='${t.id}' data-libraryId='${t.libraryId}' data-roomId='${t.roomId}' &nbsp&nbsp ${editIcon} </a>
                    <a href='#' ${hrefdel} data-Id='${t.id}' data-libraryId='${t.libraryId}' data-roomId='${t.roomId}'> &nbsp&nbsp
                        ${delIcon} </a></td>`:"<td> <a href='#'><\/a><\/td>";i+="<\/tr>";$("#indexDataTable tbody").append(i)});$("#indexDataTable").DataTable().draw();$("#indexDataTable_filter > label > input").addClass("searchRecords");$("#indexDataTable_filter > label").addClass("searchLabel");$("#indexDataTable_length > label").addClass("searchLabel")};$("#Libraries").on("change",async function(){if(this.value==="-1"){$("#Rooms").prop("disabled",!0);return}$("#Rooms").prop("disabled",!1);$("#LibraryId").val(this.value)});$("#modelFormSection").submit(async function(n){showLoader();n.preventDefault();$("#LibraryId").val($("#Libraries").find(":selected").val());$("#RoomId").val($("#Rooms").find(":selected").val());let i=getFormElementsData($(this)).Id;var u=JSON.stringify(getFormElementsData($(this)));let r=`https://localhost/ApiGateway/${apiModuleSection}/save?useCache=${backroundCache}`;i!==""&&(r=`https://localhost/ApiGateway/${apiModuleSection}/update?id=${i}&useCache=${backroundCache}`);let t={};t.urlPathToSave=r;t.formData=u;t.cacheKeyLibrary=cacheKeyLibrary;t.cacheKeyRoom=cacheKeyRoom;t.cacheKeySection=cacheKeySection;t.sessionId=`Sections_${scopeTokenData.id}`;t.apiUrlToGetAll=`https://localhost/ApiGateway/${apiModuleSection}/getall?useCache=${backroundCache}&RoomId=${$("#RoomId").val()}`;t.FillSectionTable=fillSectionTable;await submitForm(t)});submitForm=async function(n){$.ajax({type:"POST",url:n.urlPathToSave,data:n.formData,headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token,"Content-Type":"application/json; charset=utf-8"},beforeSend:function(){showLoader()},success:function(t){if(displayAlert(t),t.status==="Success"){$("#modal-default").modal("toggle");$("#indexDataTable").DataTable().destroy();$("#indexDataTable tbody").empty();let f=$("#LibraryId").val(),u=$("#RoomId").val();n.libId=f;n.roomId=u;GetDataFromLocalStorage(`${cacheKeySection}_${u}`,sessionId,n.useCache).then(function(i){i?(addRowToIndex(i,t.Result,t.Result.id,n),n.FillSectionTable(i)):FetchSectionRecords(u,f,n)}).catch(n=>{console.log(n.message)});var i=$("#Libraries").find(":selected").text(),r=$("#Rooms").find(":selected").text();$("#SelectedLibrariesOnIndex").find("option:contains("+i+")").attr("selected","selected");$("#SelectedRoomsOnIndex").find("option:contains("+r+")").attr("selected","selected");$("#modelFormRoom").each(function(){this.reset()});$("#Id").val("");$("#Name").val("");$("#LibraryId").val("");$("#RoomId").val("");resetButtonState()}hideLoader()},error:function(n,t,i){console.log(n);console.log(t);console.log(i);toastr.warning("Opps! Something went wrong!","Error")},complete:function(){hideLoader()}})};let addRowToIndex=async function(n,t,i,r){let u=!1;return $.each(n.Result,function(n,r){r.id===i&&(r.name=t.name,r.isEditable=!0,u=!0)}),u||(t.isEditable=!0,n.Result.push(t)),await SetDataToLocalStorage(`${cacheKeySection}_${r.roomId}`,r.sessionId,n,20)};$("#newRecord").click(function(){changeButtonCRUDState();changeButtonCRUDState();var n=$("#SelectedLibrariesOnIndex").val(),t=$("#SelectedRoomsOnIndex").val();$("#Name").prop("disabled",!0);$("#Libraries").empty();$("#Rooms").empty();n!=="-1"&&t!=="-1"&&$("#Name").prop("disabled",!1);loadLibraryAndRoomOnModel(n,t)});$(document).on("click",".open-ModelSection",async function(){var i=$(this).attr("data-id"),n=$(this).attr("data-roomId"),t=$(this).attr("data-libraryId");showLoader();$("#modal-default").modal("show");changeButtonCRUDState();$("#Libraries").empty();$("#Rooms").empty();loadLibraryAndRoomOnModel(t,n);loadSectionRecordForEdit(i,n,t);$("#Name").focus()});let loadLibraryAndRoomOnModel=async function(n,t){$("#SelectedLibrariesOnIndex option").each(function(){this.value===n?$("#Libraries").append($("<option selected><\/option>").attr("value",this.value).text(this.text)):$("#Libraries").append($("<option><\/option>").attr("value",this.value).text(this.text))});$("#SelectedRoomsOnIndex option").each(function(){this.value===t?$("#Rooms").append($("<option selected><\/option>").attr("value",this.value).text(this.text)):$("#Rooms").append($("<option><\/option>").attr("value",this.value).text(this.text))})};loadSectionRecordForEdit=async function(n,t,i){$.ajax({type:"GET",datatype:"json",url:`https://localhost/ApiGateway/section/get?id=${n}&roomid=${t}`,headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token,"Content-Type":"application/json; charset=utf-8"},success:function(n){n.status==="Success"&&($("#Name").val(n.Result.name),$("#Id").val(n.Result.id),$("#LibraryId").val(i),$("#RoomId").val(t),$("#Libraries").empty(),$("#Rooms").empty(),loadLibraryAndRoomOnModel(i,t),$("#Libraries").prop("disabled",!0),$("#Rooms").prop("disabled",!0),$("#Libraries").attr("title","Moving room to another library is not permitted!"),$("#Rooms").attr("title","Moving room to another room is not permitted!"),n.Result.isEditable===!1&&($("#saveLi").css("display","none"),$("#cancelLi").css("display","block")),hideLoader(),$("#Name").focus())},error:function(n,t,i){console.log(n);console.log(t);console.log(i);toastr.warning("Opps! something went wrong!","Error");hideLoader()}})};$(document).on("click",".delete-SectionRecord",async function(){var t=$(this).data("id"),n;let i=$(this);n=$(this).attr("data-roomId");swal({title:"Are you sure?",text:"Once deleted, you will not be able to recover this record!",icon:"warning",buttons:!0,dangerMode:!0}).then(r=>{r&&(showLoader(),deleteSectionData(i,`https://localhost/ApiGateway/section/delete?useCache=${backroundCache}&id=${t}&roomid=${n}`,t,n))})});deleteSectionData=function(n,t,i,r){$.ajax({type:"GET",datatype:"json",url:t,headers:{School:jsTokenObject.schoolName,Authorization:jsTokenObject.token,"Content-Type":"application/json; charset=utf-8"},success:function(t){if(hideLoader(),t.status==="Success"){GetDataFromLocalStorage(`${cacheKeySection}_${r}`,sessionId,jsFormObject.useCache).then(function(n){if(n&&(n.Result=n.Result.filter(n=>n.id!==i),SetDataToLocalStorage(`${cacheKeySection}_${r}`,sessionId,n,20),n.Result.length>0)){fillSectionTable(n);$(".searchLabel").focus();return}});swal("Ohh! Your record has been deleted!",{icon:"success",timer:3e3});var u=$("#indexDataTable").DataTable();u.row(n.parents("tr")).remove().draw()}else swal("Ohh! "+t.message,{icon:"error"})},error:function(n,t,i){console.log(n);console.log(t);console.log(i);toastr.warning(i,"Error!");hideLoader()},complete:function(){hideLoader()}})};